<html>
	<head>
		<meta charset="utf-8">
		<title>Projeto ecs4</title>
		
		<script src="https://d3js.org/d3.v5.min.js"></script>
	</head>
	<body>
	
		<datalist id="tickmarks">
			<option value="0" />
			<option value="10" />
			<option value="20" />
			<option value="30" />
			<option value="40" />
			<option value="50" />
			<option value="60" />
			<option value="70" />
			<option value="80" />
			<option value="90" />
			<option value="100" />
			<option value="200" />
			<option value="300" />
			<option value="400" />
			<option value="500" />
			<option value="600" />
			<option value="700" />
			<option value="800" />
			<option value="900" />
			<option value="1000" />
		</datalist>

<p id="demo"></p></br>

		<svg id="grafico" width="800" height="800" />

		</br>

		<script>
		// Variaveis globais para me ajudar
		let dataset = undefined;
		let width = 800;
		let height = 800;

		class QualityInfo {
			constructor(element) {
				this.qaDefault = element.qaDefault;
				this.qaDPI = +element.qaDPI;
				this.qaDensity = +element.qaDensity;
				this.qaInclination = +element.qaInclination;
				this.qaLightness = +element.qaLightness;
				this.qaShadow = +element.qaShadow;
				this.qaFocus = +element.qaFocus;
				this.qaShine = +element.qaShine;
			}
			getResult() {
				if (!(this.qaDefault === "OK")) {
					return this.qaDefault;
				}
				else if (this.qaDPI < getSliderValue("qaDpi")){
					return "Resolução (DPI)";
				}
				else if (100 * this.qaDensity < getSliderValue("qaDensity")){
					return "Densidade";
				}
				else if (this.qaInclination > getSliderValue("qaInclination")){
					return "Inclinação";
				}
				else if (100 * this.qaLightness < getSliderValue("qaLightness")){
					return "Iluminação";
				}
				else if (100 * this.qaShadow < getSliderValue("qaShadow")){
					return "Sombra";
				}
				else if (100 * this.qaFocus < getSliderValue("qaFocus")){
					return "Foco";
				}
				else if (100 * this.qaShine < getSliderValue("qaShine")){
					return "Brilho";
				}
				else {
					return "OK";
				}
			}
		}
		class ClassificationInfo {
			constructor(element) {
				this.classification = element.classification;
				this.confidence = +element.classificationConf;
			}
			getResult() {
				if (100 * this.confidence >= getSliderValue("classifConf")){
					return this.classification;
				}
				else {
					return "Desconhecido";
				}
			}
		}
		class ExtractionInfo {
			constructor(infoName, sim, conf) {
				this.infoName = infoName;
				this.similarity = +sim;
				this.confidence = +conf;
			}
			getResult() {
				let realStatus = this.confidence >= getSliderValue(this.infoName + "Sim");
				let predictedStatus = this.similarity >= getSliderValue(this.infoName + "Conf");
				
				if (predictedStatus) {
					if (realStatus) {
						return "TP";
					}
					else {
						return "FP";
					}
				}
				else {
					if (realStatus) {
						return "FN";
					}
					else {
						return "TN";
					}
				}
			}
		}
		
		class ElementInfo {
			constructor(procError, qaInfo, classInfo, extractInfo) {
				this.procError = procError;
				this.qaInfo = qaInfo;
				this.classInfo = classInfo;
				this.extractInfo = extractInfo;
			}
		}

		// Lendo Arquivo
		d3.csv("https://raw.githubusercontent.com/EduardoCintraSimoes/ProjetoVisualizacao/main/dataset.csv")
		//d3.csv("dataset.csv")
			.then(function(data){
				//processar dados
				dataset = [];

				data.forEach(function(element){
					let qaInfo = new QualityInfo(element);
					let classInfo = new ClassificationInfo(element);
				
					dataset.push(new ElementInfo(element.processorError, qaInfo, classInfo,
						new ExtractionInfo("expeditionDate", element.expeditionDateSim, element.expeditionDateSim)));
					
					dataset.push(new ElementInfo(element.processorError, qaInfo, classInfo,
						new ExtractionInfo("birthdate", element.birthdateSim, element.birthdateConf)));
						
					dataset.push(new ElementInfo(element.processorError, qaInfo, classInfo,
						new ExtractionInfo("filiationA", element.filiationASim, element.filiationAConf)));
						
					dataset.push(new ElementInfo(element.processorError, qaInfo, classInfo,
						new ExtractionInfo("filiationB", element.filiationBSim, element.filiationBConf)));
						
					dataset.push(new ElementInfo(element.processorError, qaInfo, classInfo,
						new ExtractionInfo("birthplace", element.birthplaceSim, element.birthplaceConf)));
						
					dataset.push(new ElementInfo(element.processorError, qaInfo, classInfo,
						new ExtractionInfo("name", element.nameSim, element.nameConf)));
						
					dataset.push(new ElementInfo(element.processorError, qaInfo, classInfo,
						new ExtractionInfo("cpf", element.cpfSim, element.cpfConf)));
					
					dataset.push(new ElementInfo(element.processorError, qaInfo, classInfo,
						new ExtractionInfo("rg", element.rgSim, element.rgConf)));
				});
				setInterface();
			});

		//Seta os eventos
		function setInterface(){
		
			var newGroup = d3.select("body").append("table").attr("border",1);//.append("g");
		
			// controles de qualidade
			var rowGroup = newGroup.append("tr");
			setSlider(rowGroup.append("th"), "qaDpi", "DPI", 100, 1000, 200);
			setSlider(rowGroup.append("th"), "qaDensity", "Densidade", 0, 50, 5, 0.1);
			setSlider(rowGroup.append("th"), "qaInclination", "Inclinação", 0, 40, 2, 0.1);
			setSlider(rowGroup.append("th"), "qaLightness", "Iluminação", 0, 100, 60);
			setSlider(rowGroup.append("th"), "qaShadow", "Sombra", 0, 100, 60);
			setSlider(rowGroup.append("th"), "qaFocus", "Foco", 0, 100, 60);
			setSlider(rowGroup.append("th"), "qaShine", "Brilho", 0, 100, 60);
			
			// controles de classificação
			setSlider(rowGroup.append("th"), "classifConf", "Classificação", 0, 100, 70);
			
			// controles de extração
			var rowGroup = newGroup.append("tr");
			setExtractionSlider(rowGroup.append("th"), "expeditionDate", "Data de Expedição");
			setExtractionSlider(rowGroup.append("th"), "birthdate", "Data de Nascimento");
			setExtractionSlider(rowGroup.append("th"), "filiationA", "Filiação A");
			setExtractionSlider(rowGroup.append("th"), "filiationB", "Filiação B");
			setExtractionSlider(rowGroup.append("th"), "birthplace", "Naturalidade");
			setExtractionSlider(rowGroup.append("th"), "name", "Nome");
			setExtractionSlider(rowGroup.append("th"), "cpf", "CPF");
			setExtractionSlider(rowGroup.append("th"), "rg", "RG");
			
			//	
			let svg = d3.select("svg");
			svg.append("g").attr("id","groupEixoX").attr("transform","translate(0,780)");
			svg.append("g").attr("id","groupEixoY").attr("transform","translate(50,0)");
			svg.append("g").attr("id","groupCircles");
			svg.append("text").attr("id","tooltip");
			drawData();
		}

		function setExtractionSlider(newGroup, name, text) {
			newGroup.text(text); // título
			newGroup.append("br");
			setSlider( newGroup, name + "Conf", "Confiança", 0, 100, 70); // confiança
			newGroup.append("br");
			setSlider( newGroup, name + "Sim", "Similaridade", 0, 100, 90); // similaridade
		}

		function setSlider(newGroup, name, text, minVal, maxVal, defaultVal, step = 1) {
			var sliderTag = name + "Slider";
			var labelTag = name + "Label";
			
			// texto
			newGroup.append("label").text(text + ": ");
			newGroup.append("label").attr("id", labelTag).text(defaultVal);
			newGroup.append("br");
			
			// barra
			newGroup.append("input").attr("id", sliderTag).attr("type", "range").attr("step",step)
				.attr("min", minVal).attr("max", maxVal).attr("value", defaultVal).attr("list","tickmarks");
			
			//evento de mudança do valor do slider
			d3.select("#" + sliderTag).on("change",function(){
				let aux = getSliderValue(name);
				d3.select("#" + labelTag).text(aux);
				drawData();
			});
		}
		
		// retorna o valor da barra
		function getSliderValue(name) {
			return +d3.select("#" + name + "Slider").node().value;
		}
		
		//Desenha gráfico
		function drawData(){
			//document.getElementById("demo").innerHTML = JSON.stringify(dataset[0]);
			document.getElementById("demo").innerHTML = JSON.stringify(dataset[0].qaInfo) + "\n" + dataset[0].qaInfo.getResult();
			//document.getElementById("demo").innerHTML = JSON.stringify(dataset[0].classInfo) + "\n" + dataset[0].classInfo.getResult();
			//document.getElementById("demo").innerHTML = JSON.stringify(dataset[0].extractInfo) + "\n" + dataset[0].extractInfo.getResult();				
		}
		</script>

	</body>
</html>