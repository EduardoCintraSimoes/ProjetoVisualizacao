<html>
	<head>
		<meta charset="utf-8">
		<title>Projeto ecs4</title>
		
		<script src="https://d3js.org/d3.v6.min.js"></script>
		
		<script src="https://unpkg.com/d3-array@1"></script>
		<script src="https://unpkg.com/d3-collection@1"></script>
		<script src="https://unpkg.com/d3-path@1"></script>
		<script src="https://unpkg.com/d3-shape@1"></script>
		<script src="https://unpkg.com/d3-sankey@0"></script>
		<script src="https://unpkg.com/d3-simple-slider"></script>
		
		<script src="databaseInfo.js"></script>
		<script src="slider.js"></script>
		<script src="tooltip.js"></script>
		<script src="pie.js"></script>
	</head>
	<body>
	
		<datalist id="smallTickmarks">
			<option value="0"/>
			<option value="1" />
			<option value="2" />
			<option value="3" />
			<option value="4" />
			<option value="5" />
			<option value="6" />
			<option value="7" />
			<option value="8" />
			<option value="9" />
			<option value="10" />
		</datalist>
			
		<datalist id="tickmarks">
			<option value="0" />
			<option value="10" />
			<option value="20" />
			<option value="30" />
			<option value="40" />
			<option value="50" />
			<option value="60" />
			<option value="70" />
			<option value="80" />
			<option value="90" />
			<option value="100" />
			<option value="200" />
			<option value="300" />
			<option value="400" />
		</datalist>

		<script>
			
//  Variaveis globais  //
			let dataset = undefined;
			let width = 1100;
			let height = 750;
			var margin = {top: 5, right: 30, bottom: 5, left: 5};
			
			var histograms = new Map();
	
			var svg = d3.select("body").append("svg")
				.attr("width", width + margin.left + margin.right)
				.attr("height", height + margin.top + margin.bottom)
				.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");
			
			var nodesGroup = svg.append("g")
				.attr("stroke", "#000");
				
			var linksGroup = svg.append("g")
				.attr("fill", "none")
				.attr("stroke-opacity", 0.5);
				
			var textsGroup = svg.append("g")
				.attr("font-family", "sans-serif")
				.attr("font-weight", "bold")
				.attr("stroke", "white")
				.attr("paint-order", "stroke")
				.attr("stroke-width", "2px")
				.attr("font-size", 14);
			
			createToolTip();
			
			var sankey = d3.sankey()
				.nodeId(d => d.name)
				.nodeWidth(15)
				.nodePadding(20)
				.nodeAlign(d3.sankeyLeft)
				.nodeSort(orderNodes)
				.linkSort(orderLinks)
				.extent([[1, 5], [width - 1, height - 5]]);
			
			var mapNodes = undefined;
			var mapLinks = undefined;
			
//  Dados  //
			// Lendo Arquivo
			d3.csv("https://raw.githubusercontent.com/EduardoCintraSimoes/ProjetoVisualizacao/main/dataset.csv")
				.then(function(data){
					dataset = loadDataset(data);
					setInterface();
				});

//  Funções  //
			//Seta os eventos
			function setInterface(){
			
				var newGroup = d3.select("body").append("table").attr("border",1);//.append("g");
			
				// controles de qualidade
				var qaColor = "#00d060";
				var rowGroup = newGroup.append("tr");
				setSlider(rowGroup.append("th"), "qaDpi", "DPI", 100, 350, 200, 1, false, qaColor);
				setSlider(rowGroup.append("th"), "qaDensity", "Densidade", 0, 40, 5, 0.1, false, qaColor);
				setSlider(rowGroup.append("th"), "qaInclination", "Inclinação", 0, 5, 2, 0.1, true, qaColor);
				setSlider(rowGroup.append("th"), "qaLightness", "Iluminação", 0, 100, 60, 1, false, qaColor);
				setSlider(rowGroup.append("th"), "qaShadow", "Sombra", 0, 100, 60, 1, false, qaColor);
				setSlider(rowGroup.append("th"), "qaFocus", "Foco", 0, 100, 60, 1, false, qaColor);
				setSlider(rowGroup.append("th"), "qaShine", "Brilho", 0, 100, 0, 1, false, qaColor);
				
				// controles de classificação
				setSlider(rowGroup.append("th"), "classifConf", "Classificação", 0, 100, 30, 1, false, "#ed9000");
				
				// controles de extração
				var rowGroup = newGroup.append("tr");
				setExtractionSlider(rowGroup.append("th"), "DATA_EXPEDICAO", "Data de Expedição");
				setExtractionSlider(rowGroup.append("th"), "DATA_NASCIMENTO", "Data de Nascimento");
				setExtractionSlider(rowGroup.append("th"), "FILIACAO_A", "Filiação A");
				setExtractionSlider(rowGroup.append("th"), "FILIACAO_B", "Filiação B");
				setExtractionSlider(rowGroup.append("th"), "NATURALIDADE", "Naturalidade");
				setExtractionSlider(rowGroup.append("th"), "NOME", "Nome");
				setExtractionSlider(rowGroup.append("th"), "NUM_CPF", "CPF");
				setExtractionSlider(rowGroup.append("th"), "NUM_RG", "RG");
				
				drawData();
			}

			function blendColor(colorA, colorB, amount) {
				let invAmount = 1 - amount;
				const [rA, gA, bA] = colorA.match(/\w\w/g).map((c) => parseInt(c, 16));
				const [rB, gB, bB] = colorB.match(/\w\w/g).map((c) => parseInt(c, 16));
				const nR = Math.round(rA * amount + rB * invAmount).toString(16).padStart(2, '0');
				const nG = Math.round(gA * amount + gB * invAmount).toString(16).padStart(2, '0');
				const nB = Math.round(bA * amount + bB * invAmount).toString(16).padStart(2, '0');
				return '#' + nR + nG + nB;
			}
			
			function orderNodes(nA, nB) {
				if(nA.order < nB.order) {
					return -1;
				}
				else if(nA.order > nB.order) {
					return 1;
				}
				else{
					return (nA.name < nB.name) ? -1 : ( (nA.name > nB.name) ? 1 : 0 );
				}
			}
			
			function orderLinks(lA, lB) {
				let order = orderNodes(lA.target, lB.target);
				if(order == 0)
				{
					order = orderNodes(lA.source, lB.source);
				}
				return order;
			}
			
			//Desenha gráfico
			function drawData(){
				mapLinks = new Map();
				mapNodes = new Map();
				
				// pega os valores
				dataset.forEach(function(element){
					element.updateMap();
				});
				
				// dados
				var nodes = Array.from(mapNodes.values());
				var links = Array.from(mapLinks.values());
				
				var graph = sankey({
					nodes: nodes.map(d => Object.assign({}, d)),
					links: links.map(d => Object.assign({}, d))
				});
				
				nodesGroup
					.selectAll("rect")
						.data(graph.nodes)
							.join("rect")
								.attr("x", d => d.x0)
								.attr("x", d => d.x0)
								.attr("y", d => d.y0)
								.attr("height", d => d.y1 - d.y0)
								.attr("width", d => d.x1 - d.x0)
								.attr("fill", d => d.color)
								.on('mouseover', (d, i) => showToolTip(d, i))
								.on('mousemove', (d, i) => moveToolTip(d, i))
								.on('mouseout', hideToolTip)
								.append("title")
									.text(d => d.name);
				
				const link = linksGroup
					.selectAll("g")
					.data(graph.links)
					.join("g")
						.style("mix-blend-mode", "multiply");
				
				link.selectAll("linearGradient").remove(); // remove linhas antigas		
				const gradient = link.append("linearGradient")
					.attr("id", d => fixStr(d.source.name + d.target.name))
					.attr("gradientUnits", "userSpaceOnUse")
					.attr("x1", d => d.source.x1)
					.attr("x2", d => d.target.x0);

				gradient.append("stop")
					.attr("offset", "0%")
					//.attr("stop-color", d => blendColor(d.target.color, "#ffffff", 0.5));
					.attr("stop-color", d => d.target.color);

				gradient.append("stop")
					.attr("offset", "100%")
					//.attr("stop-color", d => d.target.color);
					.attr("stop-color", d => blendColor(d.target.color, "#ffffff", 0.5));
					
				link.selectAll("path").remove(); // remove linhas antigas		
				link.append("path")
					.attr("d", d3.sankeyLinkHorizontal())
					.attr("stroke", d => "url(#" + fixStr(d.source.name + d.target.name) + ")" )
					.attr("stroke-width", d => Math.max(1, d.width));

				textsGroup
					.selectAll("text")
					.data(graph.nodes)
						.join("text")
							.attr("x", d => d.x1 + 10)
							.attr("y", d => (d.y1 + d.y0) / 2)
							.attr("dy", "0.35em")
							.attr("text-anchor", "start" )
							.text(d => getName(d));
			}
			
			function getName(d) {
				return d.name.substring(d.name.indexOf('_') + 1);
			}
			
			function fixStr(str) {
				return str.replace(/[^0-9a-zA-Z]/g, "_")
			}
			
		</script>

	</body>
</html>
